<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>如何优雅地上网？ &middot; chunYOUNG</title>
	<link rel="stylesheet" type="text/css" href="../css/index.css">
</head>
<body class="article-body">
	<nav class="article-nav">
			<a href="#">首页</a>
			<a href="#">前端作品</a>
			<a href="#">日志分类</a>
	</nav>

	<!-- 文章内容 -->
	<div class="article ">
			<div >
			  <h1 class="text-center">对HTTP的小小理解</h1>
			  <p >Mon, Apr 17, 2017</p>
			      

<p>这算是我对计算机网络的学习总结吧。我准备以一个网页请求为例，串起来相关的计算机网络协议。</p>

<h2 >计算机网络层级结构</h2>

<p>一般计算机网络的相关书籍上来就会讲网络的层次结构，一般而言自顶向下可以分为：应用层、传输层、网络层、数据链路层、物理层。对我而言主要关心的是前三个层次，对于数据链路层我会捎带一提。</p>

<p>应用层通过数据交互完成特定的任务，如超文本传输(HTTP)、文件传输(FTP)、邮件传输(SMTP)等。</p>

<p>传输层提供了应用进程逻辑通信，这一层主要包括TCP和UDP两个协议。UDP在网络层的基础上只做了必要的复用/分用和校验，不提供可靠传输、不提供面向连接的服务。TCP提供了更多的服务，它是面向连接的，提供可靠传输，顺便还提供了流量控制和拥塞控制。为了实现可靠传输，TCP有许多相关的机制，包括校验和、字节流编号、确认反馈、重传、定时器。</p>

<p>网络层提供了主机间的逻辑通信。这一层包含了网际协议IP、一堆路由选择协议、一个辅助控制协议ICMP。</p>

<p>数据链路层将网络层提供的数据封装成帧，实现节点之间的通信。</p>

<h2 >分用</h2>

<p>上面提到的每一层都包含多个协议，对于应用层一个协议可能被多个应用进程使用，那下层是如何知道把数据交给那个上层服务呢，即分用问题。</p>

<p>对于数据链路层，链路层帧有一个类型字段，通过这个字段决定交付给哪个网络层协议。</p>

<p>对于网络层，也有一个类似的协议字段，用于指出交付给哪个传输层协议。</p>

<p>对于传输层协议，情况就不一样了，因为多个应用进程可以使用同一个协议，这时我们需要的是对应用进程进行编号，于是就有了端口号。通过端口号，传输层找到应用进程。</p>

<h2 >寻址</h2>

<p>上面的分用的前提是报文已经到了这个端系统，那报文是如何找到这个端系统的呢？这里需要IP地址和MAC地址。MAC地址是对网卡接口的标识(数据链路层)，这是一个硬件地址。IP地址是网络层接口的编址(网络层)，一般是由DHCP协议自动分配获得，IP地址在某种程度上可以理解为对一个端系统的编址。其实MAC地址也可以理解为对端系统的编址，毕竟找到网卡接口了，就相当于找到这台主机了。那为啥需要两个地址？一个原因是MAC地址相对来说是完全无序的，路由功能实现起来过于复杂，IP地址一定程度上解决了这个问题。</p>

<p>到这里关于计算机网络最基础的概念已经介绍完了，然而离我们获得一个页面还有一些准备工作。首先要做的是连上网，获得IP地址，完成这项工作的是DHCP协议。</p>

<h2 >DHCP</h2>

<p>DHCP是一个应用层协议，它的主要作用是用来获取IP地址、获取子网掩码、获取默认路由器地址、获取默认DNS服务器地址。DHCP所应用的传输层协议是UDP，毕竟UDP可以提供广播服务，TCP只能进行端到端的连接。</p>

<p>当我们想要连接到网上时，本机没有IP地址，也不知道DHCP服务器(或者说DHCP服务器代理，但是对于端系统而言它起到了DHCP服务器的作用)地址，更不知道DHCP服务器的MAC地址，我们只知道源端口号和目的端口号，这两个是DHCP协议所规定的，还有源MAC地址，这是网卡出厂就决定好的。源IP地址全0表示本机、目的IP地址全1表示本网广播地址、目的MAC地址全1表示广播，这是DHCP查询报文的部分信息。</p>

<p>DHCP服务器通过广播发送了DHCP响应报文，这样本机就可以获得一个IP地址了，同时获得的还有子网掩码、默认路由器地址和DNS服务器地址。但是一个网络中可能含有多个DHCP服务器，而且UDP不提供可靠传输，所以本机还要广播一个DHCP请求报文，表明自己决定使用了哪个IP地址。最后DHCP服务器还要有个DHCP确认报文。</p>

<h2 >DNS</h2>

<p>现在上网的准备工作已经完成，我们可以打开浏览器输入某个域名了。输入完之后，我们需要获得域名到IP地址的映射关系(不考虑缓存)才能发起HTTP请求，这就需要DNS了。DNS也是一个工作在应用层的协议，它所应用的传输层协议是UDP。</p>

<p>DNS请求报文源端口号好说，毕竟是自身的应用进程表示，目的端口号是协议规定好的。向下走我们需要填写源IP地址和DNS服务器IP地址，这两个字段我们已经通过DHCP获得了。然后是目的MAC地址，上面的DHCP服务因为是广播，所以MAC地址全1，这里我们的MAC地址怎么填？这要看DNS服务器和本机的关系了，如果是在一个子网内，那我们直接填DNS服务器的MAC地址，如果不在一个子网内，我们需要填默认路由器的MAC地址。怎么判断是否在一个子网呢？还记得子网掩码吗？解决了获取谁的MAC地址，我们要回答的是怎么获取MAC地址。获取MAC地址所需要的是ARP。</p>

<p>ARP这个协议有人认为应该分到网络层，也有人认为应该分到数据链路层，还有人认为是在网络层和数据链路层之间属于跨层的协议。这些学院派的争执我们没必要关心，我们只需注意到这个协议实现的是IP地址到MAC地址的映射。</p>

<p>现在请求报文的目的MAC地址字段我们已经知道怎么填了，剩下的就是发出报文，交给DNS服务器，然后默默等待响应报文。这里DNS服务器所要做的就不说了，从端系统角度看这就是个黑盒。</p>

<h2 >HTTP</h2>

<p>HTTP请求所依赖的传输层协议是TCP，我们需要建立连接，但这个连接是只保留在端系统上的逻辑连接，并不存在于中间的链路上。</p>

<p>源端口号是系统提供的，目的端口号是协议规定好的。源IP地址是通过DHCP获取的，目的IP地址是通过DNS获取的。源MAC地址是网卡出厂自带的，目的MAC地址是通过ARP获得的默认路由器MAC地址(一般情况下本机和服务器不在一个子网内)。然后报文被交付到了路由器。</p>

<p>在路由器数据包会部分拆开，然后路由器实现路由和转发(超复杂的路由转发功能就这么被我一笔带过了)。每穿过一个路由器，目的MAC地址就会被修改，但是目标IP地址不会被修改(不考虑NAT)，这就是需要MAC地址和IP地址的第二个原因：IP地址是为主机到主机的逻辑通信服务的，MAC地址是为节点间的通信服务的。</p>

<p>最终我们的这个请求到达了服务器，然后服务器作出相应，我们获得HTTP响应报文。</p>

<h2 >结语</h2>

<p>到这里浏览网页所需要的最基本的计算机网络协议已经串起来了。一些辅助的协议，如ICMP、NAT我没有提及，但并不代表这些协议不重要。</p>

<p>以上。</p>

			</div>


		</div>
</body>
</html>